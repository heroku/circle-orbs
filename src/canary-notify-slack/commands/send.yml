description: |
  Notify the Slack webhook set in CANARY_NOTIFY_SLACK_URL of success or failure with custom attachment fields.
parameters:
  title:
    description: The initial, bolded text displayed in a notification.
    type: string
  fields-json-shell-esc:
    description: Double-quote-shell-escaped JSON string containing an array "[]" of fields to attach to the notification.
    type: string
    default: "[]"
steps:
  - run:
      name: Capture Failure condition for notification
      when: on_fail
      command: |
        echo 'export CANARY_NOTIFY_BUILD_STATUS="failure"' >> $BASH_ENV
        echo 'export CANARY_NOTIFY_COLOR="#d10d20"' >> $BASH_ENV
  - run:
      name: Capture Success condition for notification
      when: on_success
      command: |
        echo 'export CANARY_NOTIFY_BUILD_STATUS="success"' >> $BASH_ENV
        echo 'export CANARY_NOTIFY_COLOR="#1bbf43"' >> $BASH_ENV
  - run:
      name: Compose Slack notification
      when: always
      command: |
        if [ -z "$CANARY_NOTIFY_SLACK_URL"]; then
          echo "Skipping Slack notification, because CANARY_NOTIFY_SLACK_URL is not set."
          exit
        fi
        curl -X POST -H 'Content-type: application/json' \
          --data "{ \
                    \"text\": \"*<< parameters.title >>* $CANARY_NOTIFY_BUILD_STATUS on $CIRCLE_BRANCH\", \
                    \"fallback\": \"<< parameters.title >> $CANARY_NOTIFY_BUILD_STATUS on $CIRCLE_BRANCH\", \
                    \"attachments\": [ \
                      { \
                        \"type\": \"section\", \
                        \"color\": \"$CANARY_NOTIFY_COLOR\", \
                        \"fields\": << parameters.fields-json-shell-esc >>, \
                        \"actions\": [ \
                          { \
                            \"type\": \"button\", \
                            \"text\": \"CircleCI build #$CIRCLE_BUILD_NUM\", \
                            \"url\": \"$CIRCLE_BUILD_URL\" \
                          } \
                        ] \
                      } \
                    ] \
                  }" "$CANARY_NOTIFY_SLACK_URL"
