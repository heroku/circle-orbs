description: |
  Go code coverage (go test + go tool cover).
  Produces html coverage output to /tmp/coverage, which is then archived.
executor:
  name: golang
  tag: << parameters.version >>
parameters:
  version:
    description: version of golang to use (Defaults to 'latest'; must be a valid docker circleci/golang tag)
    type: string
    default: latest
  pkg-spec:
    description: Spec of packages to test (Defaults to './...')
    type: string
    default: ./...
  cache:
    description: Use circle ci cache (Defaults to 'true')
    type: boolean
    default: true
  test-opts:
    description: go test options (Defaults to '-coverprofile=coverage.txt -covermode=atomic -timeout 30s')
    type: string
    default: -coverprofile=coverage.txt -covermode=atomic -timeout 30s
steps:
  - checkout
  - when:
      condition: << parameters.cache >>
      steps:
        - restore_cache:
            keys:
              - v1-mod-cache-{{ checksum "go.sum" }}
              - v1-mod-cache-
  - go-test:
      pkg-spec: << parameters.pkg-spec >>
      test-opts: << parameters.test-opts >>
  - run:
      command: |
        go tool cover -html=coverage.txt -o coverage.html
  - run:
      command: |
        mkdir -p /tmp/coverage
        cp coverage.html /tmp/coverage
  - store_artifacts:
      path: /tmp/coverage
  - when:
      condition: << parameters.cache >>
      steps:
        - save_cache:
            key: v1-mod-cache-{{ checksum "go.sum" }}
            paths:
              - "/go/pkg/mod"
              - "/go/pkg/sumdb"
